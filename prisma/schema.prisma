generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum CreditCardType {
  CREDIT
  MEAL_TICKET
}

enum Role {
  ADMIN
  MEMBER
}

enum TransactionType {
  DEPOSIT
  EXPENSE
  INVESTMENT
}

enum TransactionPaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  BANK_SLIP
  CASH
  PIX
  OTHER
}

// --- MODELS ---

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  avatarUrl    String?  @map("avatar_url")

  themeMode    String   @default("LIGHT") @map("theme_mode")
  primaryColor String   @default("#56B22E") @map("primary_color")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  workspaceUsers WorkspaceUser[]

  @@map("users")
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  userId    String   @default("legacy_owner") @map("user_id") // Mantido legacy
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Stripe
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripeSubscriptionPlan String?   @map("stripe_subscription_plan")
  stripePriceId          String?   @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end")

  // Relacionamentos
  budgets               Budget[]
  categories            Category[]
  creditCards           CreditCard[]
  goals                 Goal[]
  membersList           Member[]
  recurringBudgets      RecurringBudget[]
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]
  invites               WorkspaceInvite[]
  workspaceUsers        WorkspaceUser[]

  @@map("workspaces")
}

model WorkspaceUser {
  userId      String   @map("user_id")
  workspaceId String   @map("workspace_id")
  role        Role     @default(MEMBER)
  createdAt   DateTime @default(now()) @map("created_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@id([userId, workspaceId])
  @@map("workspace_users")
}

model WorkspaceInvite {
  id          String   @id @default(cuid())
  workspaceId String   @map("workspace_id")
  email       String
  status      String   @default("PENDING")
  createdAt   DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, email])
  @@map("workspace_invites")
}

model Category {
  id          String          @id @default(uuid())
  name        String
  color       String?
  icon        String?
  type        TransactionType @default(EXPENSE)
  workspaceId String          @map("workspace_id")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  budgets               Budget[]
  recurringBudgets      RecurringBudget[]
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]

  @@unique([workspaceId, name])
  @@map("categories")
}

model Member {
  id          String @id @default(uuid())
  name        String
  workspaceId String @map("workspace_id")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  transactions          Transaction[]
  recurringTransactions RecurringTransaction[]

  @@unique([workspaceId, name])
  @@map("members")
}

model CreditCard {
  id            String         @id @default(uuid())
  name          String
  limit         Decimal        @db.Decimal(10, 2)
  closingDay    Int            @map("closing_day")
  dueDay        Int            @map("due_day")
  workspaceId   String         @map("workspace_id")
  icon          String?
  color         String         @default("#555050")
  type          CreditCardType @default(CREDIT)
  lastResetDate DateTime?      @map("last_reset_date")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  workspace             Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]

  @@unique([workspaceId, name])
  @@map("credit_cards")
}

model Transaction {
  id            String                   @id @default(cuid())
  name          String
  type          TransactionType
  amount        Decimal                  @db.Decimal(10, 2)
  paymentMethod TransactionPaymentMethod @map("payment_method")
  date          DateTime

  payee       String?
  observation String? @db.VarChar(255)

  // Foreign Keys
  workspaceId            String  @map("workspace_id")
  categoryId             String  @map("category_id")
  memberId               String? @map("member_id")
  goalId                 String? @map("goal_id")
  creditCardId           String? @map("credit_card_id")
  recurringTransactionId String? @map("recurring_transaction_id")

  // Parcelamento
  parentId          String? @map("parent_id")
  installmentNumber Int?    @map("installment_number")
  totalInstallments Int?    @map("total_installments")

  // Relacionamentos
  workspace            Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  category             Category              @relation(fields: [categoryId], references: [id])
  member               Member?               @relation(fields: [memberId], references: [id], onDelete: SetNull)
  creditCard           CreditCard?           @relation(fields: [creditCardId], references: [id], onDelete: SetNull)
  goal                 Goal?                 @relation(fields: [goalId], references: [id])
  recurringTransaction RecurringTransaction? @relation(fields: [recurringTransactionId], references: [id], onDelete: SetNull)

  // Auto-relacionamento (Parcelas)
  parent       Transaction?  @relation("Installments", fields: [parentId], references: [id], onDelete: Cascade)
  installments Transaction[] @relation("Installments")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("transactions")
}

model RecurringTransaction {
  id            String                   @id @default(cuid())
  name          String
  payee         String?
  amount        Decimal                  @db.Decimal(10, 2)
  dayOfPayment  Int                      @map("day_of_payment")
  type          TransactionType
  paymentMethod TransactionPaymentMethod @map("payment_method")

  startDate   DateTime  @default(now()) @map("start_date")
  endDate     DateTime? @map("end_date")
  observation String?   @db.VarChar(255)

  lastProcessedMonth String?   @map("last_processed_month")
  lastGenerated      DateTime? @map("last_generated")

  // Foreign Keys
  workspaceId  String  @map("workspace_id")
  categoryId   String  @map("category_id")
  memberId     String? @map("member_id")
  creditCardId String? @map("credit_card_id")

  // Relacionamentos
  workspace  Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  category   Category    @relation(fields: [categoryId], references: [id])
  member     Member?     @relation(fields: [memberId], references: [id], onDelete: SetNull)
  creditCard CreditCard? @relation(fields: [creditCardId], references: [id], onDelete: SetNull)

  transactions Transaction[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("recurring_transactions")
}

model Goal {
  id            String  @id @default(uuid())
  name          String
  targetAmount  Decimal @map("target_amount") @db.Decimal(10, 2)
  currentAmount Decimal @default(0) @map("current_amount") @db.Decimal(10, 2)
  workspaceId   String  @map("workspace_id")

  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("goals")
}

model Budget {
  id          String  @id @default(uuid())
  amount      Decimal @db.Decimal(10, 2)
  month       String
  workspaceId String  @map("workspace_id")
  categoryId  String  @map("category_id")

  category  Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, categoryId, month])
  @@map("budgets")
}

model RecurringBudget {
  id          String   @id @default(cuid())
  amount      Decimal  @db.Decimal(10, 2)
  workspaceId String   @map("workspace_id")
  categoryId  String   @map("category_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  category  Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, categoryId])
  @@map("recurring_budgets")
}
